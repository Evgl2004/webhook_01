# Секция events определяет параметры обработки соединений
events {
    # Максимальное количество одновременных соединений на worker процесс
    worker_connections 1024;
}

# Основная секция HTTP, содержит все настройки для HTTP-трафика
http {
    # Подключаем файл с MIME-типами (соответствие расширений файлов и их типов)
    include /etc/nginx/mime.types;

    # MIME-тип по умолчанию для случаев, когда тип файла не определен
    default_type application/octet-stream;

    # Включаем оптимизацию отправки файлов через системный вызов sendfile
    # Это ускоряет передачу статических файлов
    sendfile on;

    # Включаем оптимизацию для уменьшения количества пакетов при отправке
    # Накопление данных перед отправкой (улучшает производительность)
    tcp_nopush on;

    # Отключаем алгоритм Нейгла для уменьшения задержек
    # Данные отправляются сразу, не дожидаясь накопления
    tcp_nodelay on;

    # Таймаут keep-alive соединений в секундах
    # Как долго поддерживать открытое соединение для последующих запросов
    keepalive_timeout 65;

    # Определяем зоны для ограничения частоты запросов для webhook
    # 10 запросов в секунду с каждого IP
    # 10MB память для хранения данных о запросах
    limit_req_zone $binary_remote_addr zone=webhook:10m rate=10r/s;
    # Определяем зоны для ограничения частоты запросов для health
    # 30 запросов в минуту
    limit_req_zone $binary_remote_addr zone=health:10m rate=30r/m;
    # Ограничение количества соединений с одного IP для всего сервиса
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    # Определяем зоны для ограничения частоты запросов для Flower
    # 30 запросов в минуту
    limit_req_zone $binary_remote_addr zone=flower:10m rate=30r/m;

    # Блок server определяет виртуальный хост

    # Блок для перенаправления HTTP на HTTPS
    server {
        # Порт, который слушает nginx
        listen 80;
        # Имя сервера (домен). _ означает "любой домен"
        server_name _;

        location /.well-known/acme-challenge/ {
            root /tmp/acme-challenge;
            allow all;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Основной блок для HTTPS
    server {
        # Порт, который слушает nginx
        # После получения SLL сертификата раскомментировать.
        listen 443 ssl;

        # Имя сервера (домен). _ означает "любой домен"
        server_name _;

        # Пути к SSL-сертификатам (будут получены via Let's Encrypt)
        # После получения SLL сертификата раскомментировать.
        ssl_certificate /etc/letsencrypt/live/sagur.24vds.ru/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/sagur.24vds.ru/privkey.pem;

        # Безопасные настройки SSL
        # Подключаем файл с рекомендуемыми настройками
        include /etc/nginx/options-ssl-nginx.conf;

        # Параметры безопасности
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # Дополнительные улучшения 1
        # Скрывает версию nginx
        server_tokens off;

        # Дополнительные улучшения 2
        # Улучшенная защита от DDoS
        client_body_timeout 10;
        client_header_timeout 10;
        reset_timedout_connection on;

        # Дополнительные улучшения 3
        # Ограничение количества соединений с одного IP
        limit_conn addr 100;

        # Базовые security headers для всего сервера
        # Запрет MIME-sniffing
        add_header X-Content-Type-Options nosniff always;
        # Запрет встраивания в iframe
        add_header X-Frame-Options DENY always;
        # Защита от XSS
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:;" always;

        # Путь к файлу логов доступа (все входящие запросы)
        access_log /var/log/nginx/access.log;

        # Путь к файлу логов ошибок
        error_log /var/log/nginx/error.log;

        # Максимальный размер тела запроса от клиента
        # Защита от переполнения памяти большими файлами
        client_max_body_size 10M;

        # Запрещаем доступ к скрытым файлам
        location ~* /\.(git|htaccess|htpasswd|svn|env) {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }

        # Запрещаем доступ к служебным файлам Django
        location ~ /(README\.md|requirements\.txt|composer\.json|package\.json|web\.config|dockerfile) {
            deny all;
            return 404;
        }

        location ~* (\.php|\.asp|\.aspx|\.pl|\.cgi|\.sh|\.bak|\.save|\.old)$ {
            deny all;
            return 404;
        }

        # Блокировка сканеров уязвимостей
        location ~* /(cgi-bin|luci|wp-admin|phpMyAdmin) {
            deny all;
            access_log off;
            log_not_found off;
            return 444;
        }

        # Блокировка по User-Agent
        # Может блокировать легитимные инструменты. Лучше использовать более точные правила.
        if ($http_user_agent ~* (nmap|sqlmap|nikto|metasploit|masscan|zgrab|python-requests|Go-http-client|scanner|bot|crawler|spider)) {
            return 444;
        }

        # Ограничиваем размер тела запроса для API
        # Специальная локация для webhook с усиленной безопасностью
        location /webhooks/ {

            # БЛОКИРУЕМ опасные Content-Type
            if ($content_type ~* "multipart/form-data") {
                access_log /var/log/nginx/webhooks_blocked.log;
                return 415 "Unsupported Media Type";
            }

            # ПЕРЕДАЕМ оригинальный Content-Type
            proxy_set_header Content-Type $content_type;

            # Ограничение размера тела запроса для webhook
            client_max_body_size 1M;

            # Ограничение rate limiting для webhook (защита от спама)
            # Burst до 50 запросов - временное превышение лимита
            limit_req zone=webhook burst=20 nodelay;

            # Проксирование на Django приложение
            proxy_pass http://app:8000;

            # Стандартные proxy заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймауты для webhook (можно увеличить при необходимости)
            proxy_connect_timeout 15s;
            proxy_send_timeout 15s;
            proxy_read_timeout 15s;

            # Отключаем кэширование для webhook запросов
            # Отключаем буферизацию для real-time webhook
            proxy_buffering off;
            # Отключаем кэширование для динамических данных
            proxy_cache off;

            # Логирование webhook запросов в отдельный файл (опционально)
            access_log /var/log/nginx/webhooks_access.log;
            error_log /var/log/nginx/webhooks_error.log;
        }

        # Локация для статических файлов Django
        location /static/ {
            # Путь к директории со статическими файлами внутри контейнера nginx
            alias /app/static/;

            # Время кэширования в браузере (1 год)
            expires 1y;

            # Директивы кэширования для браузера
            # public - можно кэшировать прокси-серверам
            # immutable - файлы не изменятся, можно кэшировать надолго
            add_header Cache-Control "public, immutable";

            # Security headers для статики
            add_header X-Content-Type-Options nosniff;
        }

        # Локация для медиа-файлов Django (загруженные пользователями)
        location /media/ {
            # Путь к директории с медиа-файлами
            alias /app/media/;

            # Время кэширования в браузере
            expires 1y;

            # Директивы кэширования
            add_header Cache-Control "public";

            # Security headers для статики
            add_header X-Content-Type-Options nosniff;
        }

        # Локация для проверки состояния сервиса
        location /health {
            # Ограничение размера тела запроса
            client_max_body_size 1K;

            # Rate limiting - 30 запросов в минуту с burst до 10
            limit_req zone=health burst=10 nodelay;

            # Проксирование запросов к Django приложению
            proxy_pass http://app:8000;

            # Передаем оригинальный Host заголовок
            proxy_set_header Host $host;

            # Передаем реальный IP клиента
            proxy_set_header X-Real-IP $remote_addr;

            # Передаем цепочку прокси (если есть)
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Передаем оригинальный протокол (http/https)
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймаут подключения к бэкенду для health-check
            proxy_connect_timeout 2s;

            # Таймаут отправки данных для health-check
            proxy_send_timeout 2s;

            # Таймаут чтения ответа от бэкенда для health-check
            proxy_read_timeout 3s;

            # Минимальное логирование (только ошибки)
            access_log /var/log/nginx/health_access.log;
            error_log /var/log/nginx/health_error.log;
        }

        location /flower/ {
            # Rate limiting для Flower
            limit_req zone=flower burst=10 nodelay;
            limit_conn addr 5;

            # Важно: слеш в конце
            proxy_pass http://flower:5555/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Исправление путей
            sub_filter '/static/' '/flower-static/';
            sub_filter 'src="/' 'src="/flower/';
            sub_filter 'href="/' 'href="/flower/';
            sub_filter 'action="/' 'action="/flower/';
            sub_filter_once off;

            proxy_buffering on;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Статика Flower
        location /flower-static/ {
            proxy_pass http://flower:5555/static/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
        }

        # Основная локация - все остальные запросы
        location / {
            # Проксирование всех запросов к Django приложению
            proxy_pass http://app:8000;

            # Передаем оригинальный Host заголовок
            proxy_set_header Host $host;

            # Передаем реальный IP клиента
            proxy_set_header X-Real-IP $remote_addr;

            # Передаем цепочку прокси (для правильного определения IP)
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Передаем оригинальный протокол
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймаут установки соединения с бэкендом
            proxy_connect_timeout 30s;

            # Таймаут отправки данных бэкенду
            proxy_send_timeout 30s;

            # Таймаут чтения ответа от бэкенда
            proxy_read_timeout 30s;
        }
    }
}