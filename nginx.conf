# Секция events определяет параметры обработки соединений
events {
    # Максимальное количество одновременных соединений на worker процесс
    worker_connections 1024;
}

# Основная секция HTTP, содержит все настройки для HTTP-трафика
http {
    # Подключаем файл с MIME-типами (соответствие расширений файлов и их типов)
    include /etc/nginx/mime.types;

    # MIME-тип по умолчанию для случаев, когда тип файла не определен
    default_type application/octet-stream;

    # Включаем оптимизацию отправки файлов через системный вызов sendfile
    # Это ускоряет передачу статических файлов
    sendfile on;

    # Включаем оптимизацию для уменьшения количества пакетов при отправке
    # Накопление данных перед отправкой (улучшает производительность)
    tcp_nopush on;

    # Отключаем алгоритм Нейгла для уменьшения задержек
    # Данные отправляются сразу, не дожидаясь накопления
    tcp_nodelay on;

    # Таймаут keep-alive соединений в секундах
    # Как долго поддерживать открытое соединение для последующих запросов
    keepalive_timeout 65;

    # Путь к файлу логов доступа (все входящие запросы)
    access_log /var/log/nginx/access.log;

    # Путь к файлу логов ошибок
    error_log /var/log/nginx/error.log;

    # Максимальный размер тела запроса от клиента
    # Защита от переполнения памяти большими файлами
    client_max_body_size 10M;

    # Определяем zone для rate limiting для webhook
    # 10 запросов в секунду с каждого IP
    # 10MB память для хранения данных о запросах
    limit_req_zone $binary_remote_addr zone=webhook:10m rate=10r/s;
    # Определяем zone для rate limiting для health
    limit_req_zone $binary_remote_addr zone=health:10m rate=30r/m;  # 30 запросов в минуту

    # Блок server определяет виртуальный хост
    server {
        # Порт, который слушает nginx
        listen 80;

        # Имя сервера (домен). _ означает "любой домен"
        server_name _;

        # Дополнительные улучшения 1
        # Скрывает версию nginx
        server_tokens off;

        # Дополнительные улучшения 2
        # Улучшенная защита от DDoS
        client_body_timeout 10;
        client_header_timeout 10;
        reset_timedout_connection on;

        # Дополнительные улучшения 3
        # Ограничение количества соединений с одного IP
        limit_conn_zone $binary_remote_addr zone=addr:10m;
        limit_conn addr 100;

        # Базовые security headers для всего сервера
        # При необходимости перенести в блок webhook и health
        add_header X-Content-Type-Options nosniff always;          # Запрет MIME-sniffing
        add_header X-Frame-Options DENY always;                    # Запрет встраивания в iframe
        add_header X-XSS-Protection "1; mode=block" always;        # Защита от XSS
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Запрещаем доступ к скрытым файлам
        location ~ /\. {
            deny all;
            return 404;
        }

        # Запрещаем доступ к служебным файлам Django
        location ~ /(README\.md|requirements\.txt|\.env) {
            deny all;
            return 404;
        }

        # Ограничиваем размер тела запроса для API
        # Специальная локация для webhook с усиленной безопасностью
        location /webhooks/ {
            # Ограничение размера тела запроса для webhook
            client_max_body_size 1M;

            # Ограничение rate limiting для webhook (защита от спама)
            # Burst до 50 запросов - временное превышение лимита
            limit_req zone=webhook burst=20 nodelay;

            # Проксирование на Django приложение
            proxy_pass http://app:8000;

            # Стандартные proxy заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймауты для webhook (можно увеличить при необходимости)
            proxy_connect_timeout 15s;
            proxy_send_timeout 15s;
            proxy_read_timeout 15s;

            # Дополнительные security настройки для webhook
            # add_header X-Content-Type-Options nosniff;          # Запрет MIME-sniffing
            # add_header X-Frame-Options DENY;                    # Запрет встраивания в iframe
            # add_header X-XSS-Protection "1; mode=block";        # Защита от XSS
            # add_header Referrer-Policy "strict-origin-when-cross-origin";

            # Отключаем кэширование для webhook запросов
            proxy_buffering off;    # Отключаем буферизацию для real-time webhook
            proxy_cache off;        # Отключаем кэширование для динамических данных

            # Логирование webhook запросов в отдельный файл (опционально)
            access_log /var/log/nginx/webhooks_access.log;
            error_log /var/log/nginx/webhooks_error.log;
        }

        # Локация для статических файлов Django
        location /static/ {
            # Путь к директории со статическими файлами внутри контейнера nginx
            alias /app/static/;

            # Время кэширования в браузере (1 год)
            expires 1y;

            # Директивы кэширования для браузера
            # public - можно кэшировать прокси-серверам
            # immutable - файлы не изменятся, можно кэшировать надолго
            add_header Cache-Control "public, immutable";

            # Security headers для статики
            add_header X-Content-Type-Options nosniff;
        }

        # Локация для медиа-файлов Django (загруженные пользователями)
        location /media/ {
            # Путь к директории с медиа-файлами
            alias /app/media/;

            # Время кэширования в браузере
            expires 1y;

            # Директивы кэширования
            add_header Cache-Control "public";

            # Security headers для статики
            add_header X-Content-Type-Options nosniff;
        }

        # Локация для health-check эндпоинта
        location /health/ {
            # Ограничение размера тела запроса
            client_max_body_size 1K;

            # Rate limiting - 30 запросов в минуту с burst до 10
            limit_req zone=health burst=10 nodelay;

            # Проксирование запросов к Django приложению
            proxy_pass http://app:8000;

            # Передаем оригинальный Host заголовок
            proxy_set_header Host $host;

            # Передаем реальный IP клиента
            proxy_set_header X-Real-IP $remote_addr;

            # Передаем цепочку прокси (если есть)
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Передаем оригинальный протокол (http/https)
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймаут подключения к бэкенду для health-check
            proxy_connect_timeout 2s;

            # Таймаут отправки данных для health-check
            proxy_send_timeout 2s;

            # Таймаут чтения ответа от бэкенда для health-check
            proxy_read_timeout 3s;

            # Минимальное логирование (только ошибки)
            access_log /var/log/nginx/health_access.log;
            error_log /var/log/nginx/health_error.log;
        }

        # Основная локация - все остальные запросы
        location / {
            # Проксирование всех запросов к Django приложению
            proxy_pass http://app:8000;

            # Передаем оригинальный Host заголовок
            proxy_set_header Host $host;

            # Передаем реальный IP клиента
            proxy_set_header X-Real-IP $remote_addr;

            # Передаем цепочку прокси (для правильного определения IP)
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Передаем оригинальный протокол
            proxy_set_header X-Forwarded-Proto $scheme;

            # Таймаут установки соединения с бэкендом
            proxy_connect_timeout 30s;

            # Таймаут отправки данных бэкенду
            proxy_send_timeout 30s;

            # Таймаут чтения ответа от бэкенда
            proxy_read_timeout 30s;
        }
    }
}